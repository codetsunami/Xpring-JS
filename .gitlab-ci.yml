stages:
  - test

.test:
  image: node:12
  stage: test
  before_script:
    #- apt-get update
    #- apt-get install -y git
    - curl -L https://github.com/grpc/grpc-web/releases/download/1.0.7/protoc-gen-grpc-web-1.0.7-linux-x86_64 --output protoc-gen-grpc-web
    - mv protoc-gen-grpc-web /usr/local/bin/
    - chmod +x /usr/local/bin/protoc-gen-grpc-web
    - npm i --cache .npm --prefer-offline --no-audit --progress=false nyc codecov protoc grpc-tools
    - npm i --cache .npm --prefer-offline --no-audit --progress=false
    - git submodule update --init --recursive

compile typescript:
  stage: test
  extends: .test
  script:
    - npm run build

run tests:
  stage: test
  extends: .test
  script:
    - ./node_modules/nyc/bin/nyc.js npm test

code coverage:
  stage: test
  extends: .test
  script:
    - ./node_modules/nyc/bin/nyc.js report --reporter=text-lcov
